var Pool=require("./Pool");var PoolConfig=require("./PoolConfig");var PoolNamespace=require("./PoolNamespace");var PoolSelector=require("./PoolSelector");var Util=require("util");var EventEmitter=require("events").EventEmitter;module.exports=PoolCluster;function PoolCluster(a){EventEmitter.call(this);a=a||{};this._canRetry=typeof a.canRetry==="undefined"?true:a.canRetry;this._defaultSelector=a.defaultSelector||"RR";this._removeNodeErrorCount=a.removeNodeErrorCount||5;this._restoreNodeTimeout=a.restoreNodeTimeout||0;this._closed=false;this._findCaches=Object.create(null);this._lastId=0;this._namespaces=Object.create(null);this._nodes=Object.create(null)}Util.inherits(PoolCluster,EventEmitter);PoolCluster.prototype.add=function add(d,a){if(this._closed){throw new Error("PoolCluster is closed.")}var c=typeof d==="object"?"CLUSTER::"+(++this._lastId):String(d);if(this._nodes[c]!==undefined){throw new Error('Node ID "'+c+'" is already defined in PoolCluster.')}var b=typeof d!=="object"?new PoolConfig(a):new PoolConfig(d);this._nodes[c]={id:c,errorCount:0,pool:new Pool({config:b}),_offlineUntil:0};this._clearFindCaches()};PoolCluster.prototype.end=function end(j){var d=j!==undefined?j:_cb;if(typeof d!=="function"){throw TypeError("callback argument must be a function")}if(this._closed){process.nextTick(d);return}this._closed=true;var h=false;var g=Object.keys(this._nodes);var e=0;function a(i){if(!h&&(i||--e<=0)){h=true;d(i)}}for(var f=0;f<g.length;f++){var b=g[f];var c=this._nodes[b];e++;c.pool.end(a)}if(e===0){process.nextTick(a)}};PoolCluster.prototype.of=function(c,a){c=c||"*";a=a||this._defaultSelector;a=a.toUpperCase();if(typeof PoolSelector[a]==="undefined"){a=this._defaultSelector}var b=c+a;if(typeof this._namespaces[b]==="undefined"){this._namespaces[b]=new PoolNamespace(this,c,a)}return this._namespaces[b]};PoolCluster.prototype.remove=function remove(d){var b=this._findNodeIds(d,true);for(var a=0;a<b.length;a++){var c=this._getNode(b[a]);if(c){this._removeNode(c)}}};PoolCluster.prototype.getConnection=function(d,b,a){var c;if(typeof d==="function"){a=d;c=this.of()}else{if(typeof b==="function"){a=b;b=this._defaultSelector}c=this.of(d,b)}c.getConnection(a)};PoolCluster.prototype._clearFindCaches=function _clearFindCaches(){this._findCaches=Object.create(null)};PoolCluster.prototype._decreaseErrorCount=function _decreaseErrorCount(a){var b=a.errorCount;if(b>this._removeNodeErrorCount){b=this._removeNodeErrorCount}if(b<1){b=1}a.errorCount=b-1;if(a._offlineUntil){a._offlineUntil=0;this.emit("online",a.id)}};PoolCluster.prototype._findNodeIds=function _findNodeIds(e,c){var d=0;var b=this._findCaches[e];if(b===undefined){var f=patternRegExp(e);var a=Object.keys(this._nodes);b=a.filter(function(g){return g.match(f)});this._findCaches[e]=b}if(c){return b}return b.filter(function(h){var g=this._getNode(h);if(!g._offlineUntil){return true}if(!d){d=getMonotonicMilliseconds()}return g._offlineUntil<=d},this)};PoolCluster.prototype._getNode=function _getNode(a){return this._nodes[a]||null};PoolCluster.prototype._increaseErrorCount=function _increaseErrorCount(a){var b=++a.errorCount;if(this._removeNodeErrorCount>b){return}if(this._restoreNodeTimeout>0){a._offlineUntil=getMonotonicMilliseconds()+this._restoreNodeTimeout;this.emit("offline",a.id);return}this._removeNode(a);this.emit("remove",a.id)};PoolCluster.prototype._getConnection=function(c,a){var b=this;c.pool.getConnection(function(e,d){if(e){b._increaseErrorCount(c);a(e);return}else{b._decreaseErrorCount(c)}d._clusterId=c.id;a(null,d)})};PoolCluster.prototype._removeNode=function _removeNode(a){delete this._nodes[a.id];this._clearFindCaches();a.pool.end(_noop)};function getMonotonicMilliseconds(){var a;if(typeof process.hrtime==="function"){a=process.hrtime();a=a[0]*1000+a[1]*0.000001}else{a=process.uptime()*1000}return Math.floor(a)}function isRegExp(a){return typeof a==="object"&&Object.prototype.toString.call(a)==="[object RegExp]"}function patternRegExp(b){if(isRegExp(b)){return b}var a=b.replace(/([.+?^=!:${}()|\[\]\/\\])/g,"\\$1").replace(/\*/g,".*");return new RegExp("^"+a+"$")}function _cb(a){if(a){throw a}}function _noop(){};