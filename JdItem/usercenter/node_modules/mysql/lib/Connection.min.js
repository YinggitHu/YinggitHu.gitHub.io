var Crypto=require("crypto");var Events=require("events");var Net=require("net");var tls=require("tls");var ConnectionConfig=require("./ConnectionConfig");var Protocol=require("./protocol/Protocol");var SqlString=require("./protocol/SqlString");var Query=require("./protocol/sequences/Query");var Util=require("util");module.exports=Connection;Util.inherits(Connection,Events.EventEmitter);function Connection(a){Events.EventEmitter.call(this);this.config=a.config;this._socket=a.socket;this._protocol=new Protocol({config:this.config,connection:this});this._connectCalled=false;this.state="disconnected";this.threadId=null}function bindToCurrentDomain(b){if(!b){return undefined}var a=process.domain;return a?a.bind(b):b}Connection.createQuery=function createQuery(d,b,f){if(d instanceof Query){return d}var a=bindToCurrentDomain(f);var c={};if(typeof d==="function"){a=bindToCurrentDomain(d);return new Query(c,a)}if(typeof d==="object"){for(var e in d){c[e]=d[e]}if(typeof b==="function"){a=bindToCurrentDomain(b)}else{if(b!==undefined){c.values=b}}return new Query(c,a)}c.sql=d;c.values=b;if(typeof b==="function"){a=bindToCurrentDomain(b);c.values=undefined}if(a===undefined&&f!==undefined){throw new TypeError("argument callback must be a function when provided")}return new Query(c,a)};Connection.prototype.connect=function connect(c,d){if(!d&&typeof c==="function"){d=c;c={}}if(!this._connectCalled){this._connectCalled=true;this._socket=(this.config.socketPath)?Net.createConnection(this.config.socketPath):Net.createConnection(this.config.port,this.config.host);if(Events.usingDomains){this._socket.domain=this.domain}var b=this;this._protocol.on("data",function(e){b._socket.write(e)});this._socket.on("data",function(e){b._protocol.write(e)});this._protocol.on("end",function(){b._socket.end()});this._socket.on("end",function(){b._protocol.end()});this._socket.on("error",this._handleNetworkError.bind(this));this._socket.on("connect",this._handleProtocolConnect.bind(this));this._protocol.on("handshake",this._handleProtocolHandshake.bind(this));this._protocol.on("unhandledError",this._handleProtocolError.bind(this));this._protocol.on("drain",this._handleProtocolDrain.bind(this));this._protocol.on("end",this._handleProtocolEnd.bind(this));this._protocol.on("enqueue",this._handleProtocolEnqueue.bind(this));if(this.config.connectTimeout){var a=this._handleConnectTimeout.bind(this);this._socket.setTimeout(this.config.connectTimeout,a);this._socket.once("connect",function(){this.setTimeout(0,a)})}}this._protocol.handshake(c,bindToCurrentDomain(d))};Connection.prototype.changeUser=function changeUser(a,c){if(!c&&typeof a==="function"){c=a;a={}}this._implyConnect();var b=(a.charset)?ConnectionConfig.getCharsetNumber(a.charset):this.config.charsetNumber;return this._protocol.changeUser({user:a.user||this.config.user,password:a.password||this.config.password,database:a.database||this.config.database,timeout:a.timeout,charsetNumber:b,currentConfig:this.config},bindToCurrentDomain(c))};Connection.prototype.beginTransaction=function beginTransaction(a,b){if(!b&&typeof a==="function"){b=a;a={}}a=a||{};a.sql="START TRANSACTION";a.values=null;return this.query(a,b)};Connection.prototype.commit=function commit(a,b){if(!b&&typeof a==="function"){b=a;a={}}a=a||{};a.sql="COMMIT";a.values=null;return this.query(a,b)};Connection.prototype.rollback=function rollback(a,b){if(!b&&typeof a==="function"){b=a;a={}}a=a||{};a.sql="ROLLBACK";a.values=null;return this.query(a,b)};Connection.prototype.query=function query(d,b,a){var c=Connection.createQuery(d,b,a);c._connection=this;if(!(typeof d==="object"&&"typeCast" in d)){c.typeCast=this.config.typeCast}if(c.sql){c.sql=this.format(c.sql,c.values)}this._implyConnect();return this._protocol._enqueue(c)};Connection.prototype.ping=function ping(a,b){if(!b&&typeof a==="function"){b=a;a={}}this._implyConnect();this._protocol.ping(a,bindToCurrentDomain(b))};Connection.prototype.statistics=function statistics(a,b){if(!b&&typeof a==="function"){b=a;a={}}this._implyConnect();this._protocol.stats(a,bindToCurrentDomain(b))};Connection.prototype.end=function end(b,d){var a=d;var c=b;if(!d&&typeof b==="function"){a=b;c=null}c=Object.create(c||null);if(c.timeout===undefined){c.timeout=30000}this._implyConnect();this._protocol.quit(c,bindToCurrentDomain(a))};Connection.prototype.destroy=function(){this.state="disconnected";this._implyConnect();this._socket.destroy();this._protocol.destroy()};Connection.prototype.pause=function(){this._socket.pause();this._protocol.pause()};Connection.prototype.resume=function(){this._socket.resume();this._protocol.resume()};Connection.prototype.escape=function(a){return SqlString.escape(a,false,this.config.timezone)};Connection.prototype.escapeId=function escapeId(a){return SqlString.escapeId(a,false)};Connection.prototype.format=function(b,a){if(typeof this.config.queryFormat==="function"){return this.config.queryFormat.call(this,b,a,this.config.timezone)}return SqlString.format(b,a,this.config.stringifyObjects,this.config.timezone)};if(tls.TLSSocket){Connection.prototype._startTLS=function _startTLS(a){var c=this;var d=tls.createSecureContext({ca:this.config.ssl.ca,cert:this.config.ssl.cert,ciphers:this.config.ssl.ciphers,key:this.config.ssl.key,passphrase:this.config.ssl.passphrase});this._socket.removeAllListeners("data");this._protocol.removeAllListeners("data");var f=this.config.ssl.rejectUnauthorized;var b=false;var e=new tls.TLSSocket(this._socket,{rejectUnauthorized:f,requestCert:true,secureContext:d,isServer:false});e.on("_tlsError",function(g){if(b){c._handleNetworkError(g)}else{a(g)}});e.pipe(this._protocol);this._protocol.on("data",function(g){e.write(g)});e.on("secure",function(){b=true;a(f?this.ssl.verifyError():null)});e._start()}}else{Connection.prototype._startTLS=function _startTLS(a){var c=this;var f=Crypto.createCredentials({ca:this.config.ssl.ca,cert:this.config.ssl.cert,ciphers:this.config.ssl.ciphers,key:this.config.ssl.key,passphrase:this.config.ssl.passphrase});var g=this.config.ssl.rejectUnauthorized;var b=false;var e=tls.createSecurePair(f,false,true,g);e.on("error",function(h){if(b){c._handleNetworkError(h)}else{a(h)}});this._socket.removeAllListeners("data");this._protocol.removeAllListeners("data");e.encrypted.pipe(this._socket);this._socket.on("data",function(h){e.encrypted.write(h)});e.cleartext.pipe(this._protocol);this._protocol.on("data",function(h){e.cleartext.write(h)});e.on("secure",function(){b=true;if(!g){a();return}var i=this.ssl.verifyError();var h=i;if(typeof h==="string"){h=new Error(i);h.code=i}a(h)});e._cycle=e.cycle;e.cycle=function d(){if(this.ssl&&this.ssl.error){this.error()}return this._cycle.apply(this,arguments)}}}Connection.prototype._handleConnectTimeout=function(){if(this._socket){this._socket.setTimeout(0);this._socket.destroy()}var a=new Error("connect ETIMEDOUT");a.errorno="ETIMEDOUT";a.code="ETIMEDOUT";a.syscall="connect";this._handleNetworkError(a)};Connection.prototype._handleNetworkError=function(a){this._protocol.handleNetworkError(a)};Connection.prototype._handleProtocolError=function(a){this.state="protocol_error";this.emit("error",a)};Connection.prototype._handleProtocolDrain=function(){this.emit("drain")};Connection.prototype._handleProtocolConnect=function(){this.state="connected";this.emit("connect")};Connection.prototype._handleProtocolHandshake=function _handleProtocolHandshake(a){this.state="authenticated";this.threadId=a.threadId};Connection.prototype._handleProtocolEnd=function(a){this.state="disconnected";this.emit("end",a)};Connection.prototype._handleProtocolEnqueue=function _handleProtocolEnqueue(a){this.emit("enqueue",a)};Connection.prototype._implyConnect=function(){if(!this._connectCalled){this.connect()}};