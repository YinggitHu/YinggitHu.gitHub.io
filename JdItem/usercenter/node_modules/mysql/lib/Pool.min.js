var mysql=require("../");var Connection=require("./Connection");var EventEmitter=require("events").EventEmitter;var Util=require("util");var PoolConnection=require("./PoolConnection");module.exports=Pool;Util.inherits(Pool,EventEmitter);function Pool(a){EventEmitter.call(this);this.config=a.config;this.config.connectionConfig.pool=this;this._acquiringConnections=[];this._allConnections=[];this._freeConnections=[];this._connectionQueue=[];this._closed=false}Pool.prototype.getConnection=function(a){if(this._closed){var e=new Error("Pool is closed.");e.code="POOL_CLOSED";process.nextTick(function(){a(e)});return}var b;var d=this;if(this._freeConnections.length>0){b=this._freeConnections.shift();this.acquireConnection(b,a);return}if(this.config.connectionLimit===0||this._allConnections.length<this.config.connectionLimit){b=new PoolConnection(this,{config:this.config.newConnectionConfig()});this._acquiringConnections.push(b);this._allConnections.push(b);b.connect({timeout:this.config.acquireTimeout},function c(f){spliceConnection(d._acquiringConnections,b);if(d._closed){f=new Error("Pool is closed.");f.code="POOL_CLOSED"}if(f){d._purgeConnection(b);a(f);return}d.emit("connection",b);d.emit("acquire",b);a(null,b)});return}if(!this.config.waitForConnections){process.nextTick(function(){var f=new Error("No connections available.");f.code="POOL_CONNLIMIT";a(f)});return}this._enqueueCallback(a)};Pool.prototype.acquireConnection=function acquireConnection(b,a){if(b._pool!==this){throw new Error("Connection acquired from wrong pool.")}var e=this._needsChangeUser(b);var c=this;this._acquiringConnections.push(b);function d(f){spliceConnection(c._acquiringConnections,b);if(c._closed){f=new Error("Pool is closed.");f.code="POOL_CLOSED"}if(f){c._connectionQueue.unshift(a);c._purgeConnection(b);return}if(e){c.emit("connection",b)}c.emit("acquire",b);a(null,b)}if(e){b.config=this.config.newConnectionConfig();b.changeUser({timeout:this.config.acquireTimeout},d)}else{b.ping({timeout:this.config.acquireTimeout},d)}};Pool.prototype.releaseConnection=function releaseConnection(a){if(this._acquiringConnections.indexOf(a)!==-1){return}if(a._pool){if(a._pool!==this){throw new Error("Connection released to wrong pool")}if(this._freeConnections.indexOf(a)!==-1){throw new Error("Connection already released")}else{this._freeConnections.push(a);this.emit("release",a)}}if(this._closed){this._connectionQueue.splice(0).forEach(function(b){var c=new Error("Pool is closed.");c.code="POOL_CLOSED";process.nextTick(function(){b(c)})})}else{if(this._connectionQueue.length){this.getConnection(this._connectionQueue.shift())}}};Pool.prototype.end=function(a){this._closed=true;if(typeof a!=="function"){a=function(e){if(e){throw e}}}var d=false;var c=0;function b(e){if(!d&&(e||--c<=0)){d=true;a(e)}}while(this._allConnections.length!==0){c++;this._purgeConnection(this._allConnections[0],b)}if(c===0){process.nextTick(b)}};Pool.prototype.query=function(d,b,a){var c=Connection.createQuery(d,b,a);if(!(typeof d==="object"&&"typeCast" in d)){c.typeCast=this.config.connectionConfig.typeCast}if(this.config.connectionConfig.trace){c._callSite=new Error()}this.getConnection(function(f,e){if(f){c.on("error",function(){});c.end(f);return}c.once("end",function(){e.release()});e.query(c)});return c};Pool.prototype._enqueueCallback=function _enqueueCallback(b){if(this.config.queueLimit&&this._connectionQueue.length>=this.config.queueLimit){process.nextTick(function(){var c=new Error("Queue limit reached.");c.code="POOL_ENQUEUELIMIT";b(c)});return}var a=process.domain?process.domain.bind(b):b;this._connectionQueue.push(a);this.emit("enqueue")};Pool.prototype._needsChangeUser=function _needsChangeUser(b){var a=b.config;var c=this.config.connectionConfig;return a.user!==c.user||a.database!==c.database||a.password!==c.password||a.charsetNumber!==c.charsetNumber};Pool.prototype._purgeConnection=function _purgeConnection(b,c){var a=c||function(){};if(b.state==="disconnected"){b.destroy()}this._removeConnection(b);if(b.state!=="disconnected"&&!b._protocol._quitSequence){b._realEnd(a);return}process.nextTick(a)};Pool.prototype._removeConnection=function(a){a._pool=null;spliceConnection(this._allConnections,a);spliceConnection(this._freeConnections,a);this.releaseConnection(a)};Pool.prototype.escape=function(a){return mysql.escape(a,this.config.connectionConfig.stringifyObjects,this.config.connectionConfig.timezone)};Pool.prototype.escapeId=function escapeId(a){return mysql.escapeId(a,false)};function spliceConnection(c,a){var b;if((b=c.indexOf(a))!==-1){c.splice(b,1)}};