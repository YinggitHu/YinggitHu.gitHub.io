var BIT_16=Math.pow(2,16);var BIT_24=Math.pow(2,24);var BUFFER_ALLOC_SIZE=Math.pow(2,8);var IEEE_754_BINARY_64_PRECISION=Math.pow(2,53);var MAX_PACKET_LENGTH=Math.pow(2,24)-1;module.exports=PacketWriter;function PacketWriter(){this._buffer=null;this._offset=0}PacketWriter.prototype.toBuffer=function toBuffer(b){if(!this._buffer){this._buffer=new Buffer(0);this._offset=0}var g=this._buffer;var e=this._offset;var i=Math.floor(e/MAX_PACKET_LENGTH)+1;this._buffer=new Buffer(e+i*4);this._offset=0;for(var d=0;d<i;d++){var h=(d+1===i);var j=(h)?e%MAX_PACKET_LENGTH:MAX_PACKET_LENGTH;var a=b.incrementPacketNumber();this.writeUnsignedNumber(3,j);this.writeUnsignedNumber(1,a);var c=d*MAX_PACKET_LENGTH;var f=c+j;this.writeBuffer(g.slice(c,f))}return this._buffer};PacketWriter.prototype.writeUnsignedNumber=function(a,c){this._allocate(a);for(var b=0;b<a;b++){this._buffer[this._offset++]=(c>>(b*8))&255}};PacketWriter.prototype.writeFiller=function(a){this._allocate(a);for(var b=0;b<a;b++){this._buffer[this._offset++]=0}};PacketWriter.prototype.writeNullTerminatedString=function(c,b){c=c||"";c=c+"";var a=Buffer.byteLength(c,b||"utf-8")+1;this._allocate(a);this._buffer.write(c,this._offset,b);this._buffer[this._offset+a-1]=0;this._offset+=a};PacketWriter.prototype.writeString=function(b){b=b||"";b=b+"";var a=Buffer.byteLength(b,"utf-8");this._allocate(a);this._buffer.write(b,this._offset,"utf-8");this._offset+=a};PacketWriter.prototype.writeBuffer=function(b){var a=b.length;this._allocate(a);b.copy(this._buffer,this._offset);this._offset+=a};PacketWriter.prototype.writeLengthCodedNumber=function(a){if(a===null){this._allocate(1);this._buffer[this._offset++]=251;return}if(a<=250){this._allocate(1);this._buffer[this._offset++]=a;return}if(a>IEEE_754_BINARY_64_PRECISION){throw new Error('writeLengthCodedNumber: JS precision range exceeded, your number is > 53 bit: "'+a+'"')}if(a<BIT_16){this._allocate(3);this._buffer[this._offset++]=252}else{if(a<BIT_24){this._allocate(4);this._buffer[this._offset++]=253}else{this._allocate(9);this._buffer[this._offset++]=254}}this._buffer[this._offset++]=a&255;this._buffer[this._offset++]=(a>>8)&255;if(a<BIT_16){return}this._buffer[this._offset++]=(a>>16)&255;if(a<BIT_24){return}this._buffer[this._offset++]=(a>>24)&255;a=a.toString(2);a=a.substr(0,a.length-32);a=parseInt(a,2);this._buffer[this._offset++]=a&255;this._buffer[this._offset++]=(a>>8)&255;this._buffer[this._offset++]=(a>>16)&255;this._buffer[this._offset++]=0};PacketWriter.prototype.writeLengthCodedBuffer=function(b){var a=b.length;this.writeLengthCodedNumber(a);this.writeBuffer(b)};PacketWriter.prototype.writeNullTerminatedBuffer=function(a){this.writeBuffer(a);this.writeFiller(1)};PacketWriter.prototype.writeLengthCodedString=function(b){if(b===null){this.writeLengthCodedNumber(null);return}b=(b===undefined)?"":String(b);var a=Buffer.byteLength(b,"utf-8");this.writeLengthCodedNumber(a);if(!a){return}this._allocate(a);this._buffer.write(b,this._offset,"utf-8");this._offset+=a};PacketWriter.prototype._allocate=function _allocate(b){if(!this._buffer){this._buffer=new Buffer(Math.max(BUFFER_ALLOC_SIZE,b));this._offset=0;return}var d=this._buffer.length-this._offset;if(d>=b){return}var c=this._buffer.length+Math.max(BUFFER_ALLOC_SIZE,b);var a=this._buffer;this._buffer=new Buffer(c);a.copy(this._buffer)};