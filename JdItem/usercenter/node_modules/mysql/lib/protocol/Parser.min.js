var MAX_PACKET_LENGTH=Math.pow(2,24)-1;var MUL_32BIT=Math.pow(2,32);var PacketHeader=require("./PacketHeader");var BigNumber=require("bignumber.js");var BufferList=require("./BufferList");module.exports=Parser;function Parser(a){a=a||{};this._supportBigNumbers=a.config&&a.config.supportBigNumbers;this._buffer=new Buffer(0);this._nextBuffers=new BufferList();this._longPacketBuffers=new BufferList();this._offset=0;this._packetEnd=null;this._packetHeader=null;this._packetOffset=null;this._onError=a.onError||function(b){throw b};this._onPacket=a.onPacket||function(){};this._nextPacketNumber=0;this._encoding="utf-8";this._paused=false}Parser.prototype.write=function write(b){this._nextBuffers.push(b);while(!this._paused){if(!this._packetHeader){if(!this._combineNextBuffers(4)){break}this._packetHeader=new PacketHeader(this.parseUnsignedNumber(3),this.parseUnsignedNumber(1));if(this._packetHeader.number!==this._nextPacketNumber){var c=new Error("Packets out of order. Got: "+this._packetHeader.number+" Expected: "+this._nextPacketNumber);c.code="PROTOCOL_PACKETS_OUT_OF_ORDER";c.fatal=true;this._onError(c)}this.incrementPacketNumber()}if(!this._combineNextBuffers(this._packetHeader.length)){break}this._packetEnd=this._offset+this._packetHeader.length;this._packetOffset=this._offset;if(this._packetHeader.length===MAX_PACKET_LENGTH){this._longPacketBuffers.push(this._buffer.slice(this._packetOffset,this._packetEnd));this._advanceToNextPacket();continue}this._combineLongPacketBuffers();var a=true;try{this._onPacket(this._packetHeader);a=false}catch(c){if(!c||typeof c.code!=="string"||c.code.substr(0,7)!=="PARSER_"){throw c}this._onError(c);a=false}finally{this._advanceToNextPacket();if(a){process.nextTick(this.write.bind(this))}}}};Parser.prototype.append=function append(g){if(!g||g.length===0){return}var f=this._buffer.length;var h=this._packetOffset===null?this._offset:this._packetOffset;var j=f-h;var c=null;var e=!(g instanceof Array||Array.isArray(g))?[g]:g;var a=0;var b=0;for(var d=0;d<e.length;d++){a+=e[d].length}if(j!==0){c=new Buffer(j+a);b=0;b+=this._buffer.copy(c,0,h,f);for(var d=0;d<e.length;d++){b+=e[d].copy(c,b)}}else{if(e.length>1){c=new Buffer(a);b=0;for(var d=0;d<e.length;d++){b+=e[d].copy(c,b)}}else{c=e[0]}}this._buffer=c;this._offset=this._offset-h;this._packetEnd=this._packetEnd!==null?this._packetEnd-h:null;this._packetOffset=this._packetOffset!==null?this._packetOffset-h:null};Parser.prototype.pause=function(){this._paused=true};Parser.prototype.resume=function(){this._paused=false;process.nextTick(this.write.bind(this))};Parser.prototype.peak=function(){return this._buffer[this._offset]};Parser.prototype.parseUnsignedNumber=function parseUnsignedNumber(b){if(b===1){return this._buffer[this._offset++]}var a=this._buffer;var e=this._offset+b-1;var d=0;if(b>4){var c=new Error("parseUnsignedNumber: Supports only up to 4 bytes");c.offset=(this._offset-this._packetOffset-1);c.code="PARSER_UNSIGNED_TOO_LONG";throw c}while(e>=this._offset){d=((d<<8)|a[e])>>>0;e--}this._offset+=b;return d};Parser.prototype.parseLengthCodedString=function(){var a=this.parseLengthCodedNumber();if(a===null){return null}return this.parseString(a)};Parser.prototype.parseLengthCodedBuffer=function(){var a=this.parseLengthCodedNumber();if(a===null){return null}return this.parseBuffer(a)};Parser.prototype.parseLengthCodedNumber=function parseLengthCodedNumber(){if(this._offset>=this._buffer.length){var b=new Error("Parser: read past end");b.offset=(this._offset-this._packetOffset);b.code="PARSER_READ_PAST_END";throw b}var e=this._buffer[this._offset++];if(e<=250){return e}switch(e){case 251:return null;case 252:return this.parseUnsignedNumber(2);case 253:return this.parseUnsignedNumber(3);case 254:break;default:var b=new Error("Unexpected first byte"+(e?": 0x"+e.toString(16):""));b.offset=(this._offset-this._packetOffset-1);b.code="PARSER_BAD_LENGTH_BYTE";throw b}var a=this.parseUnsignedNumber(4);var d=this.parseUnsignedNumber(4);var c;if(d>>>21){c=(new BigNumber(a)).plus((new BigNumber(MUL_32BIT)).times(d)).toString();if(this._supportBigNumbers){return c}var b=new Error('parseLengthCodedNumber: JS precision range exceeded, number is >= 53 bit: "'+c+'"');b.offset=(this._offset-this._packetOffset-8);b.code="PARSER_JS_PRECISION_RANGE_EXCEEDED";throw b}c=a+(MUL_32BIT*d);return c};Parser.prototype.parseFiller=function(a){return this.parseBuffer(a)};Parser.prototype.parseNullTerminatedBuffer=function(){var a=this._nullByteOffset();var b=this._buffer.slice(this._offset,a);this._offset=a+1;return b};Parser.prototype.parseNullTerminatedString=function(){var a=this._nullByteOffset();var b=this._buffer.toString(this._encoding,this._offset,a);this._offset=a+1;return b};Parser.prototype._nullByteOffset=function(){var b=this._offset;while(this._buffer[b]!==0){b++;if(b>=this._buffer.length){var a=new Error("Offset of null terminated string not found.");a.offset=(this._offset-this._packetOffset);a.code="PARSER_MISSING_NULL_BYTE";throw a}}return b};Parser.prototype.parsePacketTerminatedString=function(){var a=this._packetEnd-this._offset;return this.parseString(a)};Parser.prototype.parseBuffer=function(b){var a=new Buffer(b);this._buffer.copy(a,0,this._offset,this._offset+b);this._offset+=b;return a};Parser.prototype.parseString=function(b){var d=this._offset;var a=d+b;var c=this._buffer.toString(this._encoding,d,a);this._offset=a;return c};Parser.prototype.parseGeometryValue=function(){var a=this.parseLengthCodedBuffer();var c=4;if(a===null||!a.length){return null}function b(){var p=null;var k=a.readUInt8(c);c+=1;var n=k?a.readUInt32LE(c):a.readUInt32BE(c);c+=4;switch(n){case 1:var l=k?a.readDoubleLE(c):a.readDoubleBE(c);c+=8;var g=k?a.readDoubleLE(c):a.readDoubleBE(c);c+=8;p={x:l,y:g};break;case 2:var h=k?a.readUInt32LE(c):a.readUInt32BE(c);c+=4;p=[];for(var e=h;e>0;e--){var l=k?a.readDoubleLE(c):a.readDoubleBE(c);c+=8;var g=k?a.readDoubleLE(c):a.readDoubleBE(c);c+=8;p.push({x:l,y:g})}break;case 3:var m=k?a.readUInt32LE(c):a.readUInt32BE(c);c+=4;p=[];for(var e=m;e>0;e--){var h=k?a.readUInt32LE(c):a.readUInt32BE(c);c+=4;var o=[];for(var d=h;d>0;d--){var l=k?a.readDoubleLE(c):a.readDoubleBE(c);c+=8;var g=k?a.readDoubleLE(c):a.readDoubleBE(c);c+=8;o.push({x:l,y:g})}p.push(o)}break;case 4:case 5:case 6:case 7:var f=k?a.readUInt32LE(c):a.readUInt32BE(c);c+=4;var p=[];for(var e=f;e>0;e--){p.push(b())}break}return p}return b()};Parser.prototype.reachedPacketEnd=function(){return this._offset===this._packetEnd};Parser.prototype.incrementPacketNumber=function(){var a=this._nextPacketNumber;this._nextPacketNumber=(this._nextPacketNumber+1)%256;return a};Parser.prototype.resetPacketNumber=function(){this._nextPacketNumber=0};Parser.prototype.packetLength=function packetLength(){if(!this._packetHeader){return null}return this._packetHeader.length+this._longPacketBuffers.size};Parser.prototype._combineNextBuffers=function _combineNextBuffers(c){var d=this._buffer.length-this._offset;if(d>=c){return true}if((d+this._nextBuffers.size)<c){return false}var b=[];var e=c-d;while(e>0){var a=this._nextBuffers.shift();b.push(a);e-=a.length}this.append(b);return true};Parser.prototype._combineLongPacketBuffers=function _combineLongPacketBuffers(){if(!this._longPacketBuffers.size){return}var b=this._buffer.length-this._offset;var d=this._buffer.length-this._packetEnd;var c=null;var a=new Buffer(b+this._longPacketBuffers.size);var e=0;while((c=this._longPacketBuffers.shift())){e+=c.copy(a,e)}this._buffer.copy(a,e,this._offset);this._buffer=a;this._offset=0;this._packetEnd=this._buffer.length-d;this._packetOffset=0};Parser.prototype._advanceToNextPacket=function(){this._offset=this._packetEnd;this._packetHeader=null;this._packetEnd=null;this._packetOffset=null};