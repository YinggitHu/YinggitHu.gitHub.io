var Buffer=require("buffer").Buffer;var Crypto=require("crypto");var Auth=exports;function sha1(b){var a=Crypto.createHash("sha1");a.update(b,"binary");return a.digest("binary")}Auth.sha1=sha1;function xor(e,d){e=new Buffer(e,"binary");d=new Buffer(d,"binary");var c=new Buffer(e.length);for(var f=0;f<e.length;f++){c[f]=(e[f]^d[f])}return c}Auth.xor=xor;Auth.token=function(b,a){if(!b){return new Buffer(0)}var e=sha1((new Buffer(b,"utf8")).toString("binary"));var d=sha1(e);var c=sha1(a.toString("binary")+d);return xor(c,e)};Auth.hashPassword=function(d){var f=[20528,22325],g=7,b=[4660,22129],a=new Buffer(8);if(typeof d==="string"){d=new Buffer(d)}for(var e=0;e<d.length;e++){var h=d[e];if(h===32||h===9){continue}f=this.xor32(f,this.add32(this.mul32(this.add32(this.and32(f,[0,63]),[0,g]),[0,h]),this.shl32(f,8)));b=this.add32(b,this.xor32(this.shl32(b,8),f));g+=h}this.int31Write(a,f,0);this.int31Write(a,b,4);return a};Auth.randomInit=function(b,a){return{max_value:1073741823,max_value_dbl:1073741823,seed1:b%1073741823,seed2:a%1073741823}};Auth.myRnd=function(a){a.seed1=(a.seed1*3+a.seed2)%a.max_value;a.seed2=(a.seed1+a.seed2+33)%a.max_value;return a.seed1/a.max_value_dbl};Auth.scramble323=function(k,j){var h=new Buffer(8),e=this.hashPassword(j),b=this.hashPassword(k.slice(0,8)),g=this.int32Read(e,0)^this.int32Read(b,0),f=this.int32Read(e,4)^this.int32Read(b,4),a=this.randomInit(g,f);for(var d=0;d<8;d++){h[d]=Math.floor(this.myRnd(a)*31)+64}var c=(Math.floor(this.myRnd(a)*31));for(var d=0;d<8;d++){h[d]^=c}return h};Auth.xor32=function(d,c){return[d[0]^c[0],d[1]^c[1]]};Auth.add32=function(f,d){var e=f[1]+d[1],c=f[0]+d[0]+((e&4294901760)>>16);return[c&65535,e&65535]};Auth.mul32=function(f,d){var e=f[1]*d[1],c=(((f[1]*d[1])>>16)&65535)+((f[0]*d[1])&65535)+(f[1]*d[0]&65535);return[c&65535,e&65535]};Auth.and32=function(d,c){return[d[0]&c[0],d[1]&c[1]]};Auth.shl32=function(f,d){var e=f[1]<<d,c=(f[0]<<d)|((e&4294901760)>>16);return[c&65535,e&65535]};Auth.int31Write=function(a,b,c){a[c]=(b[0]>>8)&127;a[c+1]=(b[0])&255;a[c+2]=(b[1]>>8)&255;a[c+3]=(b[1])&255};Auth.int32Read=function(a,b){return(a[b]<<24)+(a[b+1]<<16)+(a[b+2]<<8)+(a[b+3])};