var Parser=require("./Parser");var Sequences=require("./sequences");var Packets=require("./packets");var Timers=require("timers");var Stream=require("stream").Stream;var Util=require("util");var PacketWriter=require("./PacketWriter");module.exports=Protocol;Util.inherits(Protocol,Stream);function Protocol(a){Stream.call(this);a=a||{};this.readable=true;this.writable=true;this._config=a.config||{};this._connection=a.connection;this._callback=null;this._fatalError=null;this._quitSequence=null;this._handshakeSequence=null;this._handshaked=false;this._ended=false;this._destroyed=false;this._queue=[];this._handshakeInitializationPacket=null;this._parser=new Parser({onError:this.handleParserError.bind(this),onPacket:this._parsePacket.bind(this),config:this._config})}Protocol.prototype.write=function(a){this._parser.write(a);return true};Protocol.prototype.handshake=function handshake(a,b){if(typeof a==="function"){b=a;a={}}a=a||{};a.config=this._config;return this._handshakeSequence=this._enqueue(new Sequences.Handshake(a,b))};Protocol.prototype.query=function query(a,b){return this._enqueue(new Sequences.Query(a,b))};Protocol.prototype.changeUser=function changeUser(a,b){return this._enqueue(new Sequences.ChangeUser(a,b))};Protocol.prototype.ping=function ping(a,b){if(typeof a==="function"){b=a;a={}}return this._enqueue(new Sequences.Ping(a,b))};Protocol.prototype.stats=function stats(a,b){if(typeof a==="function"){b=a;a={}}return this._enqueue(new Sequences.Statistics(a,b))};Protocol.prototype.quit=function quit(b,d){if(typeof b==="function"){d=b;b={}}var a=this;var c=this._enqueue(new Sequences.Quit(b,d));c.on("end",function(){a.end()});return this._quitSequence=c};Protocol.prototype.end=function(){if(this._ended){return}this._ended=true;if(this._quitSequence&&(this._quitSequence._ended||this._queue[0]===this._quitSequence)){this._quitSequence.end();this.emit("end");return}var a=new Error("Connection lost: The server closed the connection.");a.fatal=true;a.code="PROTOCOL_CONNECTION_LOST";this._delegateError(a)};Protocol.prototype.pause=function(){this._parser.pause();var a=this._queue[0];if(a&&a.emit){a.emit("pause")}};Protocol.prototype.resume=function(){this._parser.resume();var a=this._queue[0];if(a&&a.emit){a.emit("resume")}};Protocol.prototype._enqueue=function(b){if(!this._validateEnqueue(b)){return b}if(this._config.trace){b._callSite=b._callSite||new Error()}this._queue.push(b);this.emit("enqueue",b);var a=this;b.on("error",function(c){a._delegateError(c,b)}).on("packet",function(c){Timers.active(b);a._emitPacket(c)}).on("end",function(){a._dequeue(b)}).on("timeout",function(){var c=new Error(b.constructor.name+" inactivity timeout");c.code="PROTOCOL_SEQUENCE_TIMEOUT";c.fatal=true;c.timeout=b._timeout;a._delegateError(c,b)}).on("start-tls",function(){Timers.active(b);a._connection._startTLS(function(c){if(c){c.code="HANDSHAKE_SSL_ERROR";c.fatal=true;b.end(c);return}Timers.active(b);b._tlsUpgradeCompleteHandler()})});if(this._queue.length===1){this._parser.resetPacketNumber();this._startSequence(b)}return b};Protocol.prototype._validateEnqueue=function _validateEnqueue(f){var d;var e="Cannot enqueue "+f.constructor.name;var c=e+" before ";var b=e+" after ";if(this._fatalError){d=new Error(b+"fatal error.");d.code="PROTOCOL_ENQUEUE_AFTER_FATAL_ERROR"}else{if(this._quitSequence){d=new Error(b+"invoking quit.");d.code="PROTOCOL_ENQUEUE_AFTER_QUIT"}else{if(this._destroyed){d=new Error(b+"being destroyed.");d.code="PROTOCOL_ENQUEUE_AFTER_DESTROY"}else{if(this._handshakeSequence&&f.constructor===Sequences.Handshake){d=new Error(b+"already enqueuing a Handshake.");d.code="PROTOCOL_ENQUEUE_HANDSHAKE_TWICE"}else{if(!this._handshakeSequence&&f.constructor===Sequences.ChangeUser){d=new Error(c+"a Handshake.");d.code="PROTOCOL_ENQUEUE_BEFORE_HANDSHAKE"}else{return true}}}}}var a=this;d.fatal=false;f.on("error",function(g){a._delegateError(g,f)});process.nextTick(function(){f.end(d)});return false};Protocol.prototype._parsePacket=function(){var e=this._queue[0];if(!e){var a=new Error("Received packet with no active sequence.");a.code="PROTOCOL_STRAY_PACKET";a.fatal=true;this._delegateError(a);return}var b=this._determinePacket(e);var d=new b({protocol41:this._config.protocol41});var c=b.name;if(b===Packets.RowDataPacket){e.RowDataPacket(d,this._parser,this._connection);if(this._config.debug){this._debugPacket(true,d)}return}if(this._config.debug){this._parsePacketDebug(d)}else{d.parse(this._parser)}if(b===Packets.HandshakeInitializationPacket){this._handshakeInitializationPacket=d}Timers.active(e);if(!e[c]){var a=new Error("Received packet in the wrong sequence.");a.code="PROTOCOL_INCORRECT_PACKET_SEQUENCE";a.fatal=true;this._delegateError(a);return}e[c](d)};Protocol.prototype._parsePacketDebug=function _parsePacketDebug(a){try{a.parse(this._parser)}finally{this._debugPacket(true,a)}};Protocol.prototype._emitPacket=function(a){var b=new PacketWriter();a.write(b);this.emit("data",b.toBuffer(this._parser));if(this._config.debug){this._debugPacket(false,a)}};Protocol.prototype._determinePacket=function(c){var a=this._parser.peak();if(c.determinePacket){var b=c.determinePacket(a,this._parser);if(b){return b}}switch(a){case 0:if(!this._handshaked){this._handshaked=true;this.emit("handshake",this._handshakeInitializationPacket)}return Packets.OkPacket;case 254:return Packets.EofPacket;case 255:return Packets.ErrorPacket}throw new Error("Could not determine packet, firstByte = "+a)};Protocol.prototype._dequeue=function(a){Timers.unenroll(a);if(this._fatalError){return}this._queue.shift();var a=this._queue[0];if(!a){this.emit("drain");return}this._parser.resetPacketNumber();this._startSequence(a)};Protocol.prototype._startSequence=function(a){if(a._timeout>0&&isFinite(a._timeout)){Timers.enroll(a,a._timeout);Timers.active(a)}if(a.constructor===Sequences.ChangeUser){a.start(this._handshakeInitializationPacket)}else{a.start()}};Protocol.prototype.handleNetworkError=function(a){a.fatal=true;var b=this._queue[0];if(b){b.end(a)}else{this._delegateError(a)}};Protocol.prototype.handleParserError=function handleParserError(a){var b=this._queue[0];if(b){b.end(a)}else{this._delegateError(a)}};Protocol.prototype._delegateError=function(b,c){if(this._fatalError){return}if(b.fatal){this._fatalError=b}if(this._shouldErrorBubbleUp(b,c)){this.emit("unhandledError",b)}else{if(b.fatal){var a=this._queue;process.nextTick(function(){a.forEach(function(d){d.end(b)});a.length=0})}}if(b.fatal){this.emit("end",b)}};Protocol.prototype._shouldErrorBubbleUp=function(a,b){if(b){if(b.hasErrorHandler()){return false}else{if(!a.fatal){return true}}}return(a.fatal&&!this._hasPendingErrorHandlers())};Protocol.prototype._hasPendingErrorHandlers=function(){return this._queue.some(function(a){return a.hasErrorHandler()})};Protocol.prototype.destroy=function(){this._destroyed=true;this._parser.pause();if(this._connection.state!=="disconnected"){if(!this._ended){this.end()}}};Protocol.prototype._debugPacket=function(a,c){var b=(a)?"<-- ":"--> ";b=b+c.constructor.name;if(Array.isArray(this._config.debug)&&this._config.debug.indexOf(c.constructor.name)===-1){return}console.log(b);console.log(c);console.log("")};